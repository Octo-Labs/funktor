# Welcome to Funktor & Serverless!
#
# This file is the main config file for your service.
# It's already configured to run Funktor, you just have to deploy it.
#
# For more info about Funktor:
#    TODO
#
# For more about serverless, check their docs:
#    docs.serverless.com
#
# Happy Coding!

# The name of your service. All your AWS resources will contain this name.
service: <%= name %>

# This causes serverless to throw an error early if the config is bad, instead of waiting for CloudFormation to try and fail to deploy it.
configValidationMode: error

# Pin the serverless framework to the 2.x line
frameworkVersion: '2'

provider:
  name: aws
  runtime: <%= runtime %>
  lambdaHashingVersion: 20201221
  environment: ${file(config/environment.yml)}
  versionFunctions: false # Reduces the amount of storage used since all Lambdas together are limited to 75GB
  iamRoleStatements:
    - ${file(config/iam_permissions/ssm.yml)}
    - ${file(config/iam_permissions/incoming_job_queue.yml)}
    <%- queue_names.each do |queue_name| -%>
    - ${file(config/iam_permissions/<%= queue_name.underscore %>_queue.yml)}
    <%- end -%>


custom:
  # Our stage is based on what is passed in when running serverless
  # commands. Or fallsback to what we have set in the provider section.
  stage: ${self:provider.stage, 'dev'}
  funktor: ${file(config/funktor.yml)}
  rubyLayer: ${file(config/ruby_layer.yml)}

package: ${file(config/package.yml)}

functions:
  incomingJobHandler: ${file(config/function_definitions/incoming_job_handler.yml)}
  <%- queue_names.each do |queue_name| -%>
  <%= queue_name.camelize %>QueueHandler: ${file(config/function_definitions/<%= queue_name.underscore %>_queue_handler.yml)}
  <%- end -%>

resources:
  - ${file(config/resources/incoming_job_queue.yml)}
  - ${file(config/resources/incoming_job_queue_user.yml)}
  - ${file(config/resources/cloudwatch_dashboard.yml)}
  <%- queue_names.each do |queue_name| -%>
  - ${file(config/resources/<%= queue_name.underscore %>_queue.yml)}
  <%- end -%>

plugins:
  - serverless-ruby-layer
